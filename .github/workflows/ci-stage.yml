name: CI/CD - Staging

on:
  push:
    branches: [ stage ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy from dev'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  AKS_CLUSTER_NAME: ecommerce-stage-aks
  AKS_RESOURCE_GROUP: ecommerce-stage-rg
  NAMESPACE: staging

jobs:
  approval:
    name: Approval Required
    runs-on: ubuntu-latest
    environment:
      name: staging-approval
    
    steps:
    - name: Wait for approval
      run: echo "Deployment to staging approved"

  promote-images:
    name: Promote Images from Dev
    runs-on: ubuntu-latest
    needs: approval
    
    strategy:
      matrix:
        service: [api-gateway, user-service, product-service, order-service, payment-service]
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Pull dev image
      run: |
        docker pull ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:dev-latest
    
    - name: Re-tag for staging
      run: |
        docker tag ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:dev-latest \
          ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:stage-latest
        docker tag ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:dev-latest \
          ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:stage-${{ github.sha }}
    
    - name: Push staging images
      run: |
        docker push ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:stage-latest
        docker push ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:stage-${{ github.sha }}
    
    - name: Run Trivy security scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:stage-latest
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    needs: promote-images
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Run E2E Tests
      run: |
        cd tests/e2e
        mvn test -Denv=staging

  deploy-stage:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: integration-tests
    environment:
      name: staging
      url: https://stage.ecommerce.yourdomain.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set AKS context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.AKS_RESOURCE_GROUP }}
        cluster-name: ${{ env.AKS_CLUSTER_NAME }}
    
    - name: Create namespace if not exists
      run: |
        kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Blue-Green Deployment
      run: |
        # Deploy green environment
        kubectl apply -f k8s/stage/ -n ${{ env.NAMESPACE }}
        kubectl set image deployment/api-gateway-green api-gateway=${{ env.REGISTRY }}/${{ github.repository }}/api-gateway:stage-latest -n ${{ env.NAMESPACE }}
        kubectl set image deployment/user-service-green user-service=${{ env.REGISTRY }}/${{ github.repository }}/user-service:stage-latest -n ${{ env.NAMESPACE }}
        kubectl set image deployment/product-service-green product-service=${{ env.REGISTRY }}/${{ github.repository }}/product-service:stage-latest -n ${{ env.NAMESPACE }}
        kubectl set image deployment/order-service-green order-service=${{ env.REGISTRY }}/${{ github.repository }}/order-service:stage-latest -n ${{ env.NAMESPACE }}
        kubectl set image deployment/payment-service-green payment-service=${{ env.REGISTRY }}/${{ github.repository }}/payment-service:stage-latest -n ${{ env.NAMESPACE }}
        
        # Wait for green deployment
        kubectl rollout status deployment/api-gateway-green -n ${{ env.NAMESPACE }} --timeout=5m
        
        # Switch traffic to green
        kubectl patch service api-gateway -n ${{ env.NAMESPACE }} -p '{"spec":{"selector":{"version":"green"}}}'
        
        # Wait and verify
        sleep 30
        
        # Scale down blue
        kubectl scale deployment api-gateway --replicas=0 -n ${{ env.NAMESPACE }}
    
    - name: Run Smoke Tests
      run: |
        export API_URL=$(kubectl get svc api-gateway -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        curl -f http://$API_URL/health || exit 1
    
    - name: Performance Tests
      run: |
        # Run load tests with k6 or similar
        docker run --rm -i loadimpact/k6 run - <tests/performance/load-test.js

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-stage]
    if: always()
    
    steps:
    - name: Notify Teams
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "${{ needs.deploy-stage.result == 'success' && '✅' || '❌' }} Staging Deployment ${{ needs.deploy-stage.result }}",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Environment:* Staging\n*Status:* ${{ needs.deploy-stage.result }}\n*Commit:* ${{ github.sha }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
