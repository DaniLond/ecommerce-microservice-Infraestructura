name: CI/CD - Development

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

env:
  REGISTRY: ghcr.io
  AKS_CLUSTER_NAME: ecommerce-dev-aks
  AKS_RESOURCE_GROUP: ecommerce-dev-rg
  NAMESPACE: development

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Cache SonarQube packages
      uses: actions/cache@v3
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar
    
    - name: SonarQube Scan
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      run: |
        mvn clean verify sonar:sonar \
          -Dsonar.projectKey=ecommerce-microservices-dev \
          -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
          -Dsonar.qualitygate.wait=true
    
    - name: SonarQube Quality Gate Check
      uses: sonarsource/sonarqube-quality-gate-action@master
      timeout-minutes: 5
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner in repo mode
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'ecommerce-microservices'
        path: '.'
        format: 'HTML'
        args: >
          --failOnCVSS 7
          --enableRetired

  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan]
    
    strategy:
      matrix:
        service: [api-gateway, user-service, product-service, order-service, payment-service]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Build with Maven
      run: |
        cd ${{ matrix.service }}
        mvn clean package -DskipTests
    
    - name: Run Unit Tests
      run: |
        cd ${{ matrix.service }}
        mvn test
    
    - name: Run Integration Tests
      run: |
        cd ${{ matrix.service }}
        mvn verify -Pintegration-tests
    
    - name: Generate Test Coverage Report
      run: |
        cd ${{ matrix.service }}
        mvn jacoco:report
    
    - name: Upload Test Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ${{ matrix.service }}/target/site/jacoco/jacoco.xml
        flags: ${{ matrix.service }}
        name: codecov-${{ matrix.service }}

  version:
    name: Generate Version
    runs-on: ubuntu-latest
    needs: build-and-test
    outputs:
      version: ${{ steps.semver.outputs.version }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0
      with:
        versionSpec: '5.x'
    
    - name: Determine Version
      id: semver
      uses: gittools/actions/gitversion/execute@v0
      with:
        useConfigFile: true
        configFilePath: .github/GitVersion.yml
    
    - name: Display Version
      run: |
        echo "SemVer: ${{ steps.semver.outputs.semVer }}"
        echo "FullSemVer: ${{ steps.semver.outputs.fullSemVer }}"

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: version
    environment:
      name: development
      url: https://dev.ecommerce.yourdomain.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set AKS context
      uses: azure/aks-set-context@v3
      with:
        resource-group: ${{ env.AKS_RESOURCE_GROUP }}
        cluster-name: ${{ env.AKS_CLUSTER_NAME }}
    
    - name: Create namespace if not exists
      run: |
        kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
    
    - name: Deploy to AKS
      run: |
        kubectl apply -f k8s/dev/ -n ${{ env.NAMESPACE }}
        kubectl set image deployment/api-gateway api-gateway=${{ env.REGISTRY }}/${{ github.repository }}/api-gateway:dev-latest -n ${{ env.NAMESPACE }}
        kubectl set image deployment/user-service user-service=${{ env.REGISTRY }}/${{ github.repository }}/user-service:dev-latest -n ${{ env.NAMESPACE }}
        kubectl set image deployment/product-service product-service=${{ env.REGISTRY }}/${{ github.repository }}/product-service:dev-latest -n ${{ env.NAMESPACE }}
        kubectl set image deployment/order-service order-service=${{ env.REGISTRY }}/${{ github.repository }}/order-service:dev-latest -n ${{ env.NAMESPACE }}
        kubectl set image deployment/payment-service payment-service=${{ env.REGISTRY }}/${{ github.repository }}/payment-service:dev-latest -n ${{ env.NAMESPACE }}
    
    - name: Verify deployment
      run: |
        kubectl rollout status deployment/api-gateway -n ${{ env.NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/user-service -n ${{ env.NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/product-service -n ${{ env.NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/order-service -n ${{ env.NAMESPACE }} --timeout=5m
        kubectl rollout status deployment/payment-service -n ${{ env.NAMESPACE }} --timeout=5m
    
    - name: Run Smoke Tests
      run: |
        export API_URL=$(kubectl get svc api-gateway -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        curl -f http://$API_URL/health || exit 1

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    if: always()
    
    steps:
    - name: Send Slack Notification on Success
      if: needs.deploy-dev.result == 'success'
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "✅ Deployment to DEV succeeded!",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Deployment Status:* ✅ SUCCESS\n*Environment:* Development\n*Version:* ${{ needs.version.outputs.version }}\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.sha }}>\n*Author:* ${{ github.actor }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Send Slack Notification on Failure
      if: needs.deploy-dev.result == 'failure'
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "❌ Deployment to DEV failed!",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Deployment Status:* ❌ FAILED\n*Environment:* Development\n*Commit:* <${{ github.event.head_commit.url }}|${{ github.sha }}>\n*Author:* ${{ github.actor }}\n*Action:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Send Email Notification
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "[FAILED] Deployment to Development - ${{ github.sha }}"
        to: ${{ secrets.TEAM_EMAIL }}
        from: DevOps CI/CD
        body: |
          Deployment to Development environment has failed.
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          
          Please check the logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
